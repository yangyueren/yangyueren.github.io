<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" />
<meta name="referrer" content="never">
<meta name="keywords" content="">
<meta name="description" content="欢迎访问[一只木头人]的个人博客">
<meta name="author" content="kveln">
<title>MIT6.S081 util | 一只木头人</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">
<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link
  href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
  rel='stylesheet' type='text/css'>
<link rel="alternate" type="application/rss+xml" title="MIT6.S081 util | 一只木头人 » Feed"
  href="https://yangyueren.github.io/atom.xml">
<link rel="stylesheet"
  href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/androidstudio.min.css">
<link href="https://yangyueren.github.io/styles/main.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/850552586/ericamcdn@0.1/css/live2d.css">

<script>hljs.initHighlightingOnLoad();</script>

  <meta property="og:description" content="MIT6.S081 util" />
  <meta property="og:url" content="https://yangyueren.github.io/post/mit6s081-util/" />
  <meta property="og:locale" content="zh-CN" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="一只木头人" />
  <!-- <script src="../assets/styles/scripts/tocScript.js"></script> -->
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://yangyueren.github.io">一只木头人</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">首页</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">归档</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">标签</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/post/about">关于</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1633243875733"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
  <!-- Page Header -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://yangyueren.github.io">一只木头人</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">首页</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">归档</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">标签</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/post/about">关于</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1633243875733"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
<header class="masthead" style="background-image: url('https://yangyueren.github.io/media/images/home-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        
          <!-- 没Title为其他页面Header -->
          
            <!-- 没Title并且有headerType为Post：文章Header -->
            <div class="post-heading">
              <span class="tags">
                
                <a href="https://yangyueren.github.io/tag/NlD7320KL/" class="tag">MIT6.S081</a>
                
              </span>
              <h1>MIT6.S081 util</h1>
              <span class="meta">
                Posted on
                2021-03-16，7 min read
              </span>
            </div>
          
        
      </div>
    </div>
  </div>
</header>
  <!-- Post Content -->
  <article id="post-content-article">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto post-content-container">
          
          <p>第一个lab是熟悉xv6的system calls</p>
<h2 id="sleep">sleep：</h2>
<p>easy难度<br>
在makefile的UPROGS添加$U/_sleep<br>
在user/sleep.c中写以下代码：</p>
<pre><code>#include &quot;kernel/types.h&quot;
#include &quot;kernel/stat.h&quot;
#include &quot;user/user.h&quot;

int
main(int argc, char *argv[])
{
  if(argc != 2){
      fprintf(2, &quot;sleep needs an int as param.\n&quot;);
      exit(1);
  }
  int i = atoi(argv[1]);
  sleep(i);
  
  exit(0);
}
</code></pre>
<h2 id="pingpong利用pipe在父子进程间通信利用子进程会继承父进程的打开文件符">pingpong：利用pipe在父子进程间通信（利用子进程会继承父进程的打开文件符）</h2>
<pre><code>#include &quot;kernel/types.h&quot;
#include &quot;kernel/stat.h&quot;
#include &quot;user/user.h&quot;

int
main(int argc, char *argv[])
{
  if(argc &gt; 1){
      fprintf(2, &quot;ping-pong doesn't need params\n&quot;);
      exit(1);
  }
  char v = 0;
  
  int parent[2];
  int child[2];
  pipe(parent);
  pipe(child);
  if(fork() == 0){
      //child
      close(child[1]);
      close(parent[0]);
      read(child[0], &amp;v, 1);
      
      if(v==0){
          printf(&quot;%d: received ping\n&quot;, getpid());
      }else{
          exit(1);
      }
      v = 1;
      write(parent[1], &amp;v, 1);
      close(child[0]);
      close(parent[1]);

  }else{
      //parent
      close(child[0]);
      close(parent[1]);
      write(child[1], &amp;v, 1);
      
      read(parent[0], &amp;v, 1);
      if(v==1){
          printf(&quot;%d: received pong\n&quot;, getpid());
      }else{
          exit(1);
      }
      close(parent[0]);
      close(child[1]);

  }
  
  exit(0);
}
</code></pre>
<h2 id="primes利用fork出来的进程树对数据进行过滤">primes：利用fork出来的进程树，对数据进行过滤</h2>
<p>及时关闭用不到的fd</p>
<pre><code>#include &quot;kernel/types.h&quot;
#include &quot;kernel/stat.h&quot;
#include &quot;kernel/param.h&quot;
#include &quot;user/user.h&quot;

/*
解题思路：
buffer的作用是保存这轮不能被筛除的数
*/

int
main(int argc, char *argv[])
{

    int fd[2];

    int buffer[36];
    int cnt = 0;
    for (int i = 2; i &lt; 36; i++)
    {
        buffer[cnt++] = i;
    }
    
    while (cnt &gt; 0)
    {   
        pipe(fd);
        if(fork() == 0)
        {
            close(fd[1]);
            int base = 0;
            cnt = -1;
            int v;
            while (read(fd[0], &amp;v, sizeof(v)))
            {
                if(cnt == -1){
                    base = v;
                    cnt = 0;
                }else if(v % base != 0){
                    buffer[cnt++] = v;
                }
            }
            close(fd[0]);
            printf(&quot;prime %d\n&quot;, base);
        }
        else
        {
            close(fd[0]);
            for (int i = 0; i &lt; cnt; i++)
            {
                write(fd[1], &amp;buffer[i], sizeof(buffer[i]));
                
            }
            close(fd[1]);
            wait(0);
            break;  //父进程跳出while循环

        }
    }
    
  
    
      
  
  exit(0);
}

</code></pre>
<h2 id="find利用fstat查看fd的元信息如果是file则拿到文件名如果是directory则读取其中的struct-dirent">find：利用fstat查看fd的元信息，如果是file，则拿到文件名，如果是directory，则读取其中的struct dirent</h2>
<pre><code>#include &quot;kernel/types.h&quot;
#include &quot;kernel/stat.h&quot;
#include &quot;user/user.h&quot;
#include &quot;kernel/fs.h&quot;

// extract b from ./a/b
void
extractname(char *path, char *buf)
{
    char *p = path + strlen(path);
    while(*--p != '/'){

    }
    strcpy(buf, p+1);
}

void
find(char *path, char *name)
{
  char buf[512], *p;
  int fd;
  struct dirent de;
  struct stat st;
  if((fd = open(path, 0)) &lt; 0){
      fprintf(2, &quot;find: cannot open %s\n&quot;, path);
        return;
  }
  //fstat是查看该fd的元信息
  if(fstat(fd, &amp;st) &lt; 0){
    fprintf(2, &quot;find: cannot stat %s\n&quot;, path);
    close(fd);
    return;
  }
  switch(st.type){
  case T_FILE:
    extractname(path, buf);
    if(strcmp(buf, name) == 0){
        printf(&quot;%s\n&quot;, path);
    }
    
    break;

  case T_DIR:
    if(strlen(path) + 1 + DIRSIZ + 1 &gt; sizeof buf){
      printf(&quot;find: path too long\n&quot;);
      break;
    }
    strcpy(buf, path);
    p = buf+strlen(buf);
    *p++ = '/';
    //文件夹也是一个file，从里面会逐个读取文件夹下的内容，每次读一个struct dirent大小
    while(read(fd, &amp;de, sizeof(de)) == sizeof(de)){
      if(de.inum == 0)
        continue;
    
      memmove(p, de.name, DIRSIZ);
      p[DIRSIZ] = 0;
      if(stat(buf, &amp;st) &lt; 0){
        printf(&quot;find: cannot stat %s\n&quot;, buf);
        continue;
      }
    //   printf(&quot;debug %s\n&quot;, buf);
      /* 出现递归
        debug ./.
        debug ././.
        debug ./././.
        debug ././././.
      */
      char *check = buf + strlen(buf);
      while(*check != '/') check--;
      check++;
      if(strcmp(check, &quot;.&quot;) == 0) continue;
      if(strcmp(check, &quot;..&quot;) == 0) continue;

      find(buf, name);
    //   printf(&quot;%s %d %d %d\n&quot;, fmtname(buf), st.type, st.ino, st.size);
    }
    break;
  }
  close(fd);

}


int
main(int argc, char *argv[])
{

  if(argc &lt; 3){
    fprintf(2, &quot;find need at least 3 params\n&quot;);
    exit(1);
  }
  find(argv[1], argv[2]);
  exit(0);
}
</code></pre>
<h2 id="xargs把上一个命令的输出作为下一个命令的输入参数">xargs：把上一个命令的输出作为下一个命令的输入参数</h2>
<pre><code>$ echo hello too | xargs echo bye
bye hello too
</code></pre>
<p>solution:</p>
<pre><code class="language-c">
#include &quot;kernel/types.h&quot;
#include &quot;kernel/stat.h&quot;
#include &quot;kernel/param.h&quot;
#include &quot;user/user.h&quot;

int
main(int argc, char *argv[])
{
  char *args[MAXARG];
  int ini_arg_num = 0;
  char buf[256] = {0};
//   printf(&quot;argc %d\n&quot;, argc);
  for(int i=1; i&lt;argc; ++i){
      if(strcmp(argv[i], &quot;-n&quot;) == 0 &amp;&amp; i==1){
          ++i;
      }else{
          args[ini_arg_num++] = argv[i];
        //   printf(&quot;%d %s\n&quot;, ini_arg_num-1, argv[i]);
      }
  }
  /*
  这里有问题 无法解析\n
  $ echo &quot;1\n2&quot; | xargs -n 1 echo line
    &quot;1\n2&quot;
    line &quot;1\n2&quot;

  */
  while(gets( buf, sizeof(buf))){
      if(strlen(buf) &lt; 1) break;
    //   printf(&quot;%d\n%s&quot;, strlen(buf), buf);
      buf[strlen(buf)-1] = 0; //清除gets读入的\n
    //   printf(&quot;%s\n&quot;, buf);
      int arg_num = ini_arg_num;
      char *p = buf;
      while (*p)
      {
          while ((*p == ' ') &amp;&amp; *p) *p++ = 0;
          if(*p) args[arg_num++] = p;
          while ((*p != ' ') &amp;&amp; *p) p++;
      }
      if(arg_num &gt;= MAXARG) fprintf(2, &quot;too many args\n&quot;);
      if(arg_num &lt; 1) fprintf(2, &quot;too few args for xargs\n&quot;);
      args[arg_num] = 0;
      if(fork() == 0){
        //   printf(&quot;%s\n&quot;, args[0]);
        //   printf(&quot;%s %s %s\n&quot;, args[1], args[2], args[3]);
        exec(args[0], args);
        exit(0);
      }else{
          wait(0);
      }
      
  }
  exit(0);
}

</code></pre>

          <div class="toc-container"><ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#sleep">sleep：</a></li>
<li><a href="#pingpong%E5%88%A9%E7%94%A8pipe%E5%9C%A8%E7%88%B6%E5%AD%90%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E5%88%A9%E7%94%A8%E5%AD%90%E8%BF%9B%E7%A8%8B%E4%BC%9A%E7%BB%A7%E6%89%BF%E7%88%B6%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E7%AC%A6">pingpong：利用pipe在父子进程间通信（利用子进程会继承父进程的打开文件符）</a></li>
<li><a href="#primes%E5%88%A9%E7%94%A8fork%E5%87%BA%E6%9D%A5%E7%9A%84%E8%BF%9B%E7%A8%8B%E6%A0%91%E5%AF%B9%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E8%BF%87%E6%BB%A4">primes：利用fork出来的进程树，对数据进行过滤</a></li>
<li><a href="#find%E5%88%A9%E7%94%A8fstat%E6%9F%A5%E7%9C%8Bfd%E7%9A%84%E5%85%83%E4%BF%A1%E6%81%AF%E5%A6%82%E6%9E%9C%E6%98%AFfile%E5%88%99%E6%8B%BF%E5%88%B0%E6%96%87%E4%BB%B6%E5%90%8D%E5%A6%82%E6%9E%9C%E6%98%AFdirectory%E5%88%99%E8%AF%BB%E5%8F%96%E5%85%B6%E4%B8%AD%E7%9A%84struct-dirent">find：利用fstat查看fd的元信息，如果是file，则拿到文件名，如果是directory，则读取其中的struct dirent</a></li>
<li><a href="#xargs%E6%8A%8A%E4%B8%8A%E4%B8%80%E4%B8%AA%E5%91%BD%E4%BB%A4%E7%9A%84%E8%BE%93%E5%87%BA%E4%BD%9C%E4%B8%BA%E4%B8%8B%E4%B8%80%E4%B8%AA%E5%91%BD%E4%BB%A4%E7%9A%84%E8%BE%93%E5%85%A5%E5%8F%82%E6%95%B0">xargs：把上一个命令的输出作为下一个命令的输入参数</a></li>
</ul>
</li>
</ul>
</div>
          
          <hr />
          <p class="next-post">下一篇：
            <a href="https://yangyueren.github.io/post/c-unique_lock-future-condition_variable/">
              <span class="post-title">
                C++ unique_lock future condition_variable&rarr;
              </span>
            </a>
          </p>
          
          <div class="comment" style="text-align: center;">
            

            
            
          </div>
        </div>
      </div>
  </article>
  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
            <li class="list-inline-item">
              <a href="https://github.com/yangyueren" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <!-- <li class="list-inline-item">
              <a href="https://yangyueren.github.io/atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li> -->
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>一只木头人</span><br>Powered by Gridea</p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://yangyueren.github.io/media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://yangyueren.github.io/media/scripts/clean-blog.min.js"></script> -->
  <script src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>▲</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));</script>
  
  <div id="landlord-parent">
    <div id="landlord">
        <div class="message" style="opacity:0"></div>
        <canvas id="live2d" width="240" height="250" class="live2d"></canvas>
    </div>
</div>

<script type="text/javascript">
    if (/(iPhone|iPad|iPod|iOS|Android)/i.test(navigator.userAgent)) {
        //移动端
        console.log("------ 移动端");
    } else {
        console.log("------ PC端 " + navigator.userAgent);

        addScript("https://cdn.jsdelivr.net/gh/850552586/ericamcdn@0.1/js/live2d.js", () => {
            // 加载完成后再loadlive2d
            loadlive2d("live2d", "https://yangyueren.github.io/media/live2d/assets/tororo.model.json");
        });

        var home_Path = "https://yangyueren.github.io/";
        addScript("https://yangyueren.github.io/media/live2d/js/message.js", () => { });
    }

    // 插入js文件，完成后callback
    function addScript(jsfile, callback) {
        var landlord_parent = document.getElementById("landlord-parent");
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = jsfile;
        landlord_parent.appendChild(script);
        script.onload = script.onreadystatechange = function () {
            if (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") {
                script.onload = script.onreadystatechange = null;
                if (callback && typeof callback == "function") {
                    callback(); //window[callback]();如果传递字符串过来 调用window['函数名']() 调用方法
                }
            }
        };
    }
</script>
  
  <script src="https://yangyueren.github.io/media/scripts/tocScript.js"></script>
</body>

</html>